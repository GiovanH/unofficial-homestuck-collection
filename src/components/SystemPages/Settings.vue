<template>
  <div class="pageBody customStyles">
    <NavBanner useCustomStyles="true" />
    <div class="card">
      <div class="settings newReader">
        <h2>New Reader Mode</h2>
        
        <NewReaderControls 
          :handleEnable="onNewReaderEnable"
          :handleDisable="onNewReaderDisable"
          :handleChange="onNewReaderChange"
        />

        <SpoilerBox kind="Granular Retcon Settings" v-if="!$isNewReader">
          <div class="settings retcons" style="padding: 0;">
            <p class="settingDesc">Normally, retcons unlock as you read through the comic naturally. You can use these settings to manually enable or disable them individually.</p>
            <dl>
              <template v-for="retcon in retconList">
                <dt :key="retcon.model + '-dt'"><label>
                  <input type="checkbox" 
                    :name="retcon.model" 
                    v-model="$localData.settings[retcon.model]" 
                    :disabled="$localData.settings.fastForward"
                    @click="toggleSetting(retcon.model)"
                  >{{retcon.label}}</label></dt>
                <dd :key="retcon.model + '-dd'" class="settingDesc">
                  Originally enabled on page <StoryPageLink :mspaId='retcon.origPage'></StoryPageLink>.
                </dd>
              </template>
            </dl>
            <p class="settingDesc" v-if="$localData.settings.fastForward">Since you are in Archival mode, these settings will have no effect.</p>
          </div>
        </SpoilerBox>

        <dl>
          <dt><label><input type="checkbox" name="notifications" v-model="$localData.settings['notifications']" @click="toggleSetting('notifications')">Show unlock notifications</label></dt>
          <dd class="settingDesc">Enables a notification that lets you know when you unlock new content elsewhere in the collection.</dd>
          <div class="subOption" v-if="$localData.settings['notifications']">
            <dt><label><input type="checkbox" name="subNotifications" v-model="$localData.settings['subNotifications']" @click="toggleSetting('subNotifications')">Show minor notifications</label></dt>
          <dd class="settingDesc">Also show notifications for minor updates like news announcements.</dd>
          </div>
        </dl>
      </div>
    </div>
    <div class="card">
      <div class="settings application">
        <h2>Application Settings</h2>
        <dl>
          <template v-for="boolSetting in settingListBoolean">
            <template v-if="!boolSetting.platform_whitelist || boolSetting.platform_whitelist.includes($root.platform)">
              <dt :key="boolSetting.model + '-dt'"><label>
                <input type="checkbox"
                  :name="boolSetting.model"
                  v-model="$localData.settings[boolSetting.model]"
                  @click="toggleSetting(boolSetting.model)"
                >{{boolSetting.label}}</label></dt>
                <!-- the spacing here is made of glass -->
              <label :key="boolSetting.model + '-label'" :for="boolSetting.model">
                <dd class="settingDesc" v-html="boolSetting.desc" />
              </label>
            </template>
          </template>
        </dl>
      </div>
    </div>
    <div class="card">
      <div class="settings enhancements">
        <h2>Enhancements</h2>
        <dl>
          <dt>Theme Override</dt>
          <dd v-if="!$isNewReader">
            <select class="themeSelector" 
              v-model="$localData.settings.themeOverride" 
              @change="onChangeThemeOverride">
              <option v-for="theme in themes" :value="theme.value" :key="theme.value">
                {{ theme.text }}
              </option>
            </select>
            <template v-if="!$isNewReader && ($localData.settings['forceThemeOverride'] || $localData.settings.themeOverride != 'default')">
              <dt><label><input type="checkbox" 
                name="forceThemeOverride" 
                v-model="$localData.settings['forceThemeOverride']" 
                @click="toggleSetting('forceThemeOverride')"> 
              Override page-specific theme changes</label></dt>
            </template>
          </dd>
          <dd v-else class="settingDesc">Finish Homestuck to unlock!</dd>

          <template v-if="!$isNewReader">
            <dt>UI Theme Override</dt>
            <dd >
              <select class="themeSelector" 
                v-model="$localData.settings.themeOverrideUI" 
                @change="$localData.root.saveLocalStorage()">
                <option v-for="theme in themes" :value="theme.value" :key="theme.value+'!ui'">
                  {{ theme.text }}
                </option>
              </select>
              <template v-if="$localData.settings.forceThemeOverrideUI || $localData.settings.themeOverrideUI != 'default'">
                <dt><label><input type="checkbox" 
                  name="forceThemeOverrideUI" 
                  v-model="$localData.settings.forceThemeOverrideUI" 
                  @click="$localData.root.saveLocalStorage()"> 
                Override page-specific theme changes</label></dt>
              </template>
            </dd>
          </template>
          <dt > 
            <!-- v-else -->
            <label>
              <input type="checkbox" name="forceThemeOverrideUIMSPA"
              :checked.prop="forceThemeOverrideUINewReaderChecked === true"
              :indeterminate.prop="forceThemeOverrideUINewReaderChecked === undefined"
              @click="forceThemeOverrideUINewReader()"> Never style UI
            </label>
            <label>
              <input type="checkbox" name="toggleDarkMode"
              :checked.prop="darkModeChecked === true"
              :indeterminate.prop="darkModeChecked === undefined"
              @click="toggleDarkMode()"> Dark Mode
            </label>
            <label v-if="$isNewReader && ($localData.settings['forceThemeOverride'] || $localData.settings.themeOverride != 'default')">
              <input type="checkbox"
                name="forceThemeOverride"
                v-model="$localData.settings['forceThemeOverride']"
                @click="toggleSetting('forceThemeOverride')">
              Override page-specific themes
            </label>
          </dt>

          <dt>Text Override</dt>
          <dd>
            <span class="settingDesc">Adjusts how the text looks on Homestuck pages, as well as the other MS Paint Adventures. A few pages will assume you're using the default look (14px Courier New Bold), so they might end up looking a little strange.
              <br>If you want to zoom the entire application, try ctrl -/+ (or âŒ˜ -/+)!</span><br>
          </dd>
          <div class="textOverrideSettings">
            <div class="knobs">
              <label>Font family:<br>
                <select class="fontSelector" v-model="$localData.settings.textOverride.fontFamily" @change="$localData.root.saveLocalStorage()">
                  <option v-for="font in fonts" :value="font.value" :key="font.value">
                    {{ font.text }}
                  </option>
                </select>
              </label>
              <div class="textOptions">
                <label v-if="$localData.settings.textOverride.fontFamily"><input type="checkbox" name="bold" v-model="$localData.settings.textOverride['bold']" @click="toggleSetting('bold', 'textOverride')"> Bold Font</label>
                <label><input type="checkbox" name="paragraphSpacing" v-model="$localData.settings.textOverride['paragraphSpacing']" @click="toggleSetting('paragraphSpacing', 'textOverride')"> Spacing between chat paragraphs</label>
                <label><input type="checkbox" name="highContrast" v-model="$localData.settings.textOverride['highContrast']" @click="toggleSetting('highContrast', 'textOverride')"> High contrast text</label>
              </div>
              <!-- <br><br> -->
              <label class="fontslider" v-if="$localData.settings.textOverride.fontFamily != 'courierAliased'">
              <!-- <label> -->
                Font size:
                <input type="range" v-model="$localData.settings.textOverride.fontSize" min="0" max="6" step="1" list="fontSize">
              </label>
              <!-- <br><br> -->
              <label class="fontslider">
                Line height:
                <input type="range" v-model="$localData.settings.textOverride.lineHeight" min="0" max="7" step="1" list="lineHeight">
              </label>
            </div>
            <div class="textpreviews">
              <!-- PageText usually require a tab change to recalculate theme. -->
              <PageText class="examplePrattle" 
              content="A young man stands in his bedroom. It just so happens that today, the 13th of April, 2009, is this young man's birthday. Though it was thirteen years ago he was given life, it is only <a href='/homestuck/1'>today</a> he will be given a name!<br><br>What will the name of this young man be?"/>
              <PageText class="examplePrattle" 
              content="|PESTERLOG|<br />-- turntechGodhead <span style=&quot;color: #e00707&quot;>[TG]</span> began pestering ectoBiologist <span style=&quot;color: #0715cd&quot;>[EB]</span> at 16:13 --<br /><br /><span style=&quot;color: #e00707&quot;>TG: hey so what sort of insane loot did you rake in today</span><br /><span style=&quot;color: #0715cd&quot;>EB: i got a little monsters poster, it's so awesome. i'm going to watch it again today, the applejuice scene was so funny.</span>"/>
              <!-- v-if="!this.$pageIsSpoiler('001926')" -->
              <PageText class="examplePrattle" 
              v-if="$localData.settings['devMode'] && !this.$pageIsSpoiler('007378')"
              content="|AUTHORLOG|<br /><span style=&quot;color: #323232&quot;>HEY.</span><br /><span style=&quot;color: #323232&quot;>VOICE IN MY HEAD.</span><br /><span style=&quot;color: #000000&quot;>Yes?</span><br /><span style=&quot;color: #323232&quot;>SHUT UP.</span>"/>
            </div>
          </div>
          
          <template v-for="boolSetting in enhancementListBoolean">
            <template v-if="!boolSetting.platform_whitelist || boolSetting.platform_whitelist.includes($root.platform)">
              <dt :key="boolSetting.model + '-dt'"><label>
                <input type="checkbox"
                  :name="boolSetting.model"
                  v-model="$localData.settings[boolSetting.model]"
                  @click="toggleSetting(boolSetting.model)"
              >{{boolSetting.label}}</label></dt> 
              <!-- the spacing here is made of glass -->
              <label :key="boolSetting.model + '-dd'" :for="boolSetting.model" >
                <dd class="settingDesc" v-html="boolSetting.desc" />
              </label>
            </template>
          </template>

        </dl>
      </div>
    </div>
    <div class="card">
      <div class="settings controversial" > <!-- TODO v-if="$isNewReader"> -->
        <h2>Controversial Content</h2>
        <p class="settingDesc">The Unofficial Homestuck Collection allows you to restore some material that was included in the original publication, but was since officially replaced by MSPA for various reasons. These options allow you to view those pages before they were edited.</p>

        <div v-if="$isNewReader">
          
          <!-- All this with the indeterminate properties is so the button renders unambigiously if the setting is changed with a mod, or by accident. -->
          <dt><label><input type="checkbox" name="enableControversial"
              @click="toggleAllControversial()"
              :checked.prop="controversialAll && !!controversialAny"
              :indeterminate.prop="controversialAny && !controversialAll"
            >Enable controversial content</label></dt>
          <p class="settingDesc">
          New Reader mode is currently enabled, so if checked, this option restores <em>all</em> this material without including spoilers or content warnings. More granular settings are available when New Reader mode is disabled, so you may wish to finish Homestuck before you come back and view this content selectively.</p>

        </div>

        <p class="settingDesc">
        These changes only affected a few pages and some side content. The page numbers are listed here, without spoilers, and the side content is only shown if it is unlocked.</p>
          
        <SpoilerBox kind="Affected Page Numbers" class="ccPageNos">
          <div class="left col">
            <h3>Homestuck</h3>
            <!-- bolin -->
            <ol>
            <li><StoryPageLink long mspaId='002238'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='002544'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='002551'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='002722'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='002730'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='002733'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='002880'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='002926'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='002970'></StoryPageLink></li>
            <li><StoryPageLink long mspaId='003620'></StoryPageLink></li>
            <!-- peachy -->
            <li><StoryPageLink long mspaId='007623'></StoryPageLink></li>
            </ol>
          </div>
          <div class="right col">
            <h3>Side content</h3>
            <ol>
            <li v-if="!$pageIsSpoiler('008753')"><a href="/pxs/summerteen-romance/31">Paradox Space - Summerteen Romance page 31</a></li>
            <li v-else>Not yet unlocked (Jan 2019)</li>
            <li v-if="!$isNewReader"><a href="/skaianet">Skaianet Systems</a></li>
            <li v-else>Not yet unlocked (Apr 2014)</li>
            </ol>
          </div>
          <!-- TODO -->
        </SpoilerBox>

        <div v-if="!$isNewReader">
          <dd class="settingDesc">
          Under this box, you can see the specific changes that were made and enable and disable them to taste.</dd>

          <SpoilerBox kind="Controversial Content" :start-open="controversialAny">

            <template v-for="cc in controversialList">
              <dt :key="cc.model + '-dt'"><label>
                <input type="checkbox" 
                  :name="cc.model" 
                  v-model="$localData.settings[cc.model]" 
                  @click="toggleSetting(cc.model)"
                  
                >{{cc.label}}</label>
                <span class="cw minor" v-for="cw in cc.cws.minor" :key="cw" v-text="cw"></span>
                <span class="cw severe" v-for="cw in cc.cws.severe" :key="cw" v-text="cw"></span>
              </dt>
              <dd :key="cc.model + '-dd'" class="settingDesc" v-html="cc.desc" />
            </template>

          </SpoilerBox>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="settings mod">
        <h2>Mod Settings</h2>

        <section class="modPrattle" v-if="!$isWebApp">
          <p class="settingDesc">
            Content, patches, and localization. Add mods to your local <a :href="'file://' + modsDir">mods directory</a>.
            You can get mods from anywhere, but a good place to start is the <a href='https://github.com/GiovanH/unofficial-homestuck-collection/wiki/Third-Party-Mods'>Third Party Mods</a> github page.

            For a detailed explanation of how mods work and how you can build your mods, take a look at the <a href='https://github.com/GiovanH/unofficial-homestuck-collection/blob/main/MODDING.md'>modding readme</a>.</p>
            <p>Mods are software just like the collection, and a malicious mod could be malware. Use normal caution and only run trusted code.</p>
        <div class='hint'>
          <p>If you've added mods to your mods directory with the application open, you can <button @click="reloadModList">refresh mod list</button> </p>
        </div>
        </section>
        <section class="modPrattle" v-else>
          <p class="settingDesc">Because you are using the webapp version of the collection, you only have access to these preloaded mods.</p>
        </section>

        <section class="group sortable row">
          <div class='col' title="Drag and drop!"><h2>Inactive</h2>
            <draggable tag="ul" group="sortable-mods">
              <li
                v-for="option in modsDisabled"
                :key="option.key"
                :data-value="option.key"
              >
                <b v-text='option.label' />
                <span class='summary' v-if='option.summary' v-text='option.summary' />
                <label class="modButton"
                  v-if="option.hasmeta"
                  @click="openSubModel(option, 'INFO_ONLY')"
                  v-text="'â„¹'"
                />
              </li>
            </draggable>
          </div>

          <div class='col' title="Drag and drop!"><h2>Active</h2>
            <draggable tag="ol" group="sortable-mods" @sort="onUpdateSortable" data-setting="modListEnabled">
              <li
                v-for="option in modsEnabled"
                :key="option.key"
                :data-value="option.key"
              >
                <b v-text='option.label' />
                <span class='summary' v-if='option.summary' v-text='option.summary' />
                <!-- n.b. hasmeta should always be true if settings exists -->
                <label class="modButton"
                  v-if="option.hasmeta || option.settingsmodel"
                  @click="openSubModel(option)"
                  v-text="option.settingsmodel ? 'âš™' : 'â„¹'"
                />
              </li>
            </draggable>
          </div>
        </section>
          
        <p class="hint">Drag mods from the pool on the left to the list on the right to enable them. Higher mods take priority on conflicts.</p>

        <!-- TODO: We need a visual indicator of the debounce here. I'm thinking a spinner that then becomes a checkmark? -->

        <div class="system">
          <p v-if="needReload" class="needreload">Some of your changes require a quick reload before they can take effect. When you're ready, click here:</p>
          <!-- v-if="$localData.settings.devMode || needReload"  -->
          <button @click="forceReload" class="reload">Reload Application</button>
        </div>
        <button v-if="$localData.settings.devMode" @click="reloadModList(); archiveReload();" class="reload">Soft reload archive (refresh mods and re-run edits)</button>
      </div>
    </div>
    <div class="card">
      <div class="settings system">
        <h2>System Settings</h2>
        <dl>
          <template v-for="boolSetting in settingListSystem">
            <template v-if="!boolSetting.platform_whitelist || boolSetting.platform_whitelist.includes($root.platform)">
              <dt :key="boolSetting.model + '-dt'"><label>
                <input type="checkbox"
                  :name="boolSetting.model"
                  v-model="$localData.settings[boolSetting.model]"
                  @click="toggleSetting(boolSetting.model)"
                >{{boolSetting.label}}</label></dt>
                <!-- the spacing here is made of glass -->
              <label :key="boolSetting.model + '-dd'" :for="boolSetting.model" >
                <dd class="settingDesc" v-html="boolSetting.desc" />
              </label>
            </template>
          </template>
        </dl>
        <div class="system">
          <span class="hint">Application version:</span> <strong>v{{$data.$appVersion}}</strong>
          <br><br>
          <span class="hint">Asset pack version:</span> <strong>v{{$archive.version}}</strong>
          <span v-if="$archive.version != $data.$expectedAssetVersion">
            <br><br>
            <span class="hint">Expected asset pack version:</span> <strong>v{{$data.$expectedAssetVersion}}</strong>
          </span>
          <br><br>
          <div v-if="!$isWebApp">
            <span class="hint">Asset pack directory:</span>
            <br>
            <strong>{{$localData.assetDir || 'None selected'}}</strong>
            <br><br>
            <a :href="log.transports.file.getFile()">Log File (for troubleshooting)</a>
            <br><br>
            <button @click="locateAssets()">Relocate assets</button>
            <br><br>
          </div>
          <button @click="factoryReset()">Factory reset</button>
        </div>
      </div>
    </div>
    <SubSettingsModal ref="modal" />
  </div>
</template>

<script>
import NavBanner from '@/components/UIElements/NavBanner.vue'
import PageText from '@/components/Page/PageText.vue'
import SpoilerBox from '@/components/UIElements/SpoilerBox.vue'
import StoryPageLink from '@/components/UIElements/StoryPageLink.vue'
import NewReaderControls from '@/components/SystemPages/NewReaderControls.vue'

import Mods from "@/mods.js"

const SubSettingsModal = () => import('@/components/UIElements/SubSettingsModal.vue')

const draggable = () => import("vuedraggable")

const log = (window.isWebApp ? { scope() { return console } } : require('electron-log'))
const ipcRenderer = require('electron').ipcRenderer

export default {
  name: 'settings',
  props: [
    'tab', 'routeParams'
  ],
  /* eslint-disable object-property-newline */
  components: {
    NavBanner, SubSettingsModal, 
    PageText, SpoilerBox, StoryPageLink, 
    draggable, NewReaderControls
  },
  title: () => "Settings",
  data: function() {
    return {
      log,
      settingListBoolean: [
        {
          model: "showAddressBar",
          label: "Show address bar",
          desc: "Embeds the jump bar at the top of the window, just like a regular address bar. When this is disabled, you can access it by clicking the jump bar button in the tab bar, or with ctrl+L (âŒ˜+L on MacOS)."
        }, {
        //   model: "mspaMode",
        //   label: "Use MSPA page numbers",
        //   desc: "Instead of having individual sets of page numbers for each story, the original MS Paint Adventures website had one continuous page count that covered the beginning of Jailbreak all the way to the end of Homestuck."
        // }, {
          model: "switchToNewTabs",
          label: "Auto-switch to new tabs",
          desc: "Opening any link in a new tab will automatically switch you to that tab."
        }, {
          model: "forceScrollBar",
          label: "Always display scroll bar",
          desc: "Opening logs on Homestuck pages can cause the scrollbar to suddenly appear, resulting in the whole page shifting to the left. This setting keeps the scrollbar visible at all times to prevent this."
        }, {
          model: 'hideFullscreenHeader', 
          label: "Hide header in fullscreen",
          desc: "Hide the application header (title bar, address bar, and tabs) in fullscreen mode (F11)."
        }, {
          model: "smoothScrolling",
          label: "Enable smooth scrolling",
          desc: "Prevents the browser from smoothing out the movement when scrolling down a page. <strong>Requires application restart to take effect. Might not do anything on some platforms!</strong>",
          platform_whitelist: ['electron']
        }, {
          model: "pixelScaling",
          label: "Pixelated image scaling",
          desc: "By default, images are scaled in a way that may make them appear blurry at higher resolutions. This setting enables nearest neighbour scaling on Homestuck and MSPA pages, allowing those images to keep their sharp edges. This effect may not look too hot on certain high DPI monitors."
        }, {
          model: "urlTooltip",
          label: "Show URL Tooltip",
          desc: "Adds a tooltip in the bottom-left corner of the window that shows you the destination of links when you hover over them, like browsers do. Test it: <a href='/help/newreader'>New reader</a>",
          platform_whitelist: ['electron']
        }
      ],
      enhancementListBoolean: [
        {
          model: "arrowNav",
          label: "Enable arrow key navigation",
          desc: "Allows you to navigate forward and backward between pages using the left and right arrow keys, and open textboxes with space."
        }, {
          model: "openLogs",
          label: "Automatically open logs",
          desc: "Collapsed text logs begin open on each page, instead of requiring you to click them."
        }, {
          model: "hqAudio",
          label: "Enable high quality Flash audio",
          desc: "This setting replaces the original compressed audio in Homestuck's Flash animations with the high quality Bandcamp releases. This has a small chance of introducing performance issues, so try disabling it if you end up experiencing problems."
        }, {
          model: "credits",
          label: "Show inline audio credits",
          desc: "Inserts audio credits below pages that use music. It shows you the name of the song, the artists involved, and has a link to the track's page in the music database."
        }, {
          model: "bandcampEmbed",
          label: "Enable online bandcamp player",
          desc: "Although the vast majority of this collection works offline, the music database allows you to use Bandcamp's online player to legally play tracks from the source. You can disable this if you don't want the collection connecting to the internet.",
          platform_whitelist: ['electron']
        }
      ],
      settingListSystem: [
        {
          model: "devMode",
          label: "Enable Developer Mode",
          desc: "It's not all that exciting. It just adds an \"Inspect Element\" shortcut to the bottom of the context menu, and shows a little more log data for mod/style developers, or troubleshooting issues. This may slightly degrade performance."
        }, {
          model: "reducedMotion",
          label: "Reduce Motion",
          desc: "Attempts to reduce the amount of automatic motion in the comic by replacing animated gifs with a manual scrubber, and requiring an explicit click before playing Flash animations."
        }, {
          model: "jsFlashes",
          label: "Enable enhanced Flash effects",
          desc: "Some Flash animations have had certain effects enhanced using JavaScript. This has a small chance of introducing performance issues, so try disabling it if you end up experiencing problems. <strong>Highly recommended.</strong>"
        }, {
          model: "ruffleFallback",
          label: "Enable Ruffle flash emulation fallback",
          desc: "If the built-in flash player is non-functional, use the latest distribution of <a href='https://ruffle.rs/'>Ruffle</a> to emulate flash."
        }, {
          model: "enableHardwareAcceleration",
          label: "Enable hardware acceleration",
          desc: "By default, the app runs with hardware acceleration disabled, as that usually results in better performance. If you're noticing performance issues (especially on non-windows devices), enabling this may help. <strong>Will only take effect after restarting the application.</strong>",
          platform_whitelist: ['electron']
        }, {
          model: "useSystemWindowDecorations",
          label: "Use system window decorations",
          desc: "Use OS-native window decorations instead of the electron title bar. <strong>Will restart the application.</strong>",
          platform_whitelist: ['electron']
        }, {
          model: "allowSysUpdateNotifs",
          label: "Enable update notifications",
          desc: "Unless this setting is disabled, the collection will check to see if there's a new version of the app available when it starts up and alert you if there is.",
          platform_whitelist: ['electron']
        }, {
          model: "useTabbedBrowsing",
          label: "Use Tabbed Browsing",
          desc: "By default, the web app only shows one page at a time, like a standard website. This setting re-enables the in-app tab bar, and the app will store your tabs in settings.",
          platform_whitelist: ['webapp']
        }
      ],
      retconList: [
        {
          model: "retcon1",
          label: "John's arms",
          origPage: "007999"
        }, {
          model: "retcon2",
          label: "John's first Zap-quest",
          origPage: "008053"
        }, {
          model: "retcon3",
          label: "John interrupting Dave and Jade",
          origPage: "008317"
        }, {
          model: "retcon4",
          label: "The oil patches",
          origPage: "008991"
        }, {
          model: "retcon5",
          label: "John's second Zap-quest",
          origPage: "009026"
        }, {
          model: "retcon6",
          label: "Terezi's password pages",
          origPage: "009057"
        }
      ],
      controversialList: [
        {
          model: "bolin",
          cws: {
            minor: ["ip"], severe: []
          },
          label: "Homestuck - Bill Bolin music",
          desc: "A decent number of Flash animations in the first year of Homestuck had music provided by <a href=\"/music/artist/bill-bolin\" target=\"_blank\">Bill Bolin</a>. When he left the team on less-than-favourable circumstances, he requested his music be removed from the comic, and the flashes he worked on were rescored."
        }, {
          model: "soluslunes",
          cws: {
            minor: ["ip"], severe: []
          },
          label: "Homestuck - SolusLunes music",
          desc: "A <a href='/mspa/003620'>single flash animation</a> (actually, a replacement for a removed Bill Bolin flash) featuring music by SolusLunes (Jared Micks) after one of the songs he submitted to Homestuck Volume 5, <em>Endless Heart</em>, turned out to be a cover of <a href=\"https://www.youtube.com/watch?v=K3-NZHCnyf4\"><em>Heart of the Creator</em></a>. (Note that this option does override a Bolin flash, even if you have the Bolin restoration enabled.)"
        }, {
          model: "unpeachy",
          cws: {
            minor: [], severe: ["race"]
          },
          label: "Homestuck - CAUCASIAN!",
          desc: `During the trickster segment of Act 6 Act 5, <a href="/mspa/007623" target="_blank">there was originally a joke regarding the skin colour of the Trickster kids</a>. This was received poorly by the fanbase, <a href="/tumblr/more-so-i-just-dialed-down-the-joke-on-page" target="_blank">and toned down shortly after.</a>`
        }, {
          model: "pxsTavros",
          cws: {
            minor: [], severe: ["body horror"]
          },
          label: "Paradox Space - Tavros Banana",
          desc: `During the original run of Paradox Space's Summerteen Romance story, <a href="/pxs/summerteen-romance/31" target="_blank">one page included a scene with graphic body horror</a>. The original version was completely unobscured, but it was later censored with additional dialogue.`
        }, {
          model: "cursedHistory",
          cws: {
            minor: [], severe: ["holocaust"]
          },
          label: "Skaianet Systems - CURSED_HISTORY",
          desc: `At the beginning of 2019, <a href="/skaianet" target="_blank">the Skaianet Systems website launched</a>, with some of Hussie's old worldbuilding notes peppered through the source code. Many people found the notes to be in extremely poor taste, and they were swiftly removed.`
        }
      ],
      themes: [
        {text: "Auto", value: "default"},
        {text: "Dark", value: "dark"},
        {text: "MSPA", value: "mspa"},
        {text: "Retro", value: "retro"},
        {text: "Scratch", value: "scratch"},
        {text: "SBaHJ", value: "sbahj"},
        {text: "Cascade", value: "cascade"},
        {text: "Trickster Mode", value: "trickster"},
        {text: "Homosuck", value: "A6A6"},
        {text: "Collide", value: "collide"},
        {text: "Team Special Olympics", value: "tso"},
        {text: "Paradox Space", value: "pxs"},
        {text: "MSPFA", value: "mspfa"}
      ],
      fonts: [
        {text: "Default", value: ""},
        {text: "Courier Prime", value: "courierPrime"},
        {text: "Verdana / Arial", value: "verdana"},
        {text: "Times New Roman", value: "times"},
        {text: "Comic Sans", value: "comicSans"},
        {text: "EB Garamond", value: "garamond"},
        {text: "Courier Aliased", value: "courierAliased"},
        {text: "OpenDyslexic", value: "openDyslexic"}
      ],
      allControversial: [
        'bolin',
        'soluslunes',
        'unpeachy',
        'pxsTavros',
        'cursedHistory'
      ],
      enableAllControversialConfirmMsg: "This option restores the removed \"controversial material\" without detailed content warnings, to avoid spoilers. \n\n Are you sure you want to enable this option now?",
      debounce: false,
      needReload: false,
      modsDir: Mods.modsDir
    }
  },
  computed: {
    controversialAll(){
      const values = this.allControversial.map(key => this.$localData.settings[key])
      return values.every(Boolean)
    },
    controversialAny(){
      const values = this.allControversial.map(key => this.$localData.settings[key])
      return values.some(Boolean)
    },
    modsEnabled() {
      return this.$localData.settings.modListEnabled.map((key) => 
        this.$root.$modChoices[key]).filter(val => !!val)
    },
    modsDisabled() {
      return Object.values(this.$root.$modChoices).filter((choice) =>
        !this.modsEnabled.includes(choice))
    },
    forceThemeOverrideUINewReaderChecked(){
      if (this.$localData.settings.themeOverrideUI == "mspa" && this.$localData.settings.forceThemeOverrideUI == true) {
        return true
      } else if (this.$localData.settings.themeOverrideUI == "default" && this.$localData.settings.forceThemeOverrideUI == false) {
        return false
      } else {
        return undefined
      }
    },
    darkModeChecked(){
      if (this.$localData.settings.themeOverride == "dark") return true
      else if (this.$localData.settings.themeOverride == "default") return false
      return undefined
    }
  },
  methods: {
    onNewReaderChange(pageId){
      const args = {
        title: "Are you sure?",
        message: 'Be careful! If you change your current page manually, you might encounter spoilers. Are you sure you want to change this setting?'
      }
      ipcRenderer.invoke('prompt-okay-cancel', args).then(answer => {
        if (answer === true)
          this.$updateNewReader(pageId, true)
        else
          this.newReaderPage = this.$newReaderCurrent
      })
    },
    onNewReaderEnable(pageId) {
        // eslint-disable-next-line no-return-assign
      this.allControversial.forEach(key => this.$localData.settings[key] = false)

      if (this.$archive.tweaks.clearThemesForNewReader) {
        this.$localData.settings.themeOverride = "default"
        this.$localData.settings.themeOverrideUI = "default"
        this.$localData.settings.forceThemeOverride = false
        this.$localData.settings.forceThemeOverrideUI = false
      }

      this.$updateNewReader(pageId, true)
    },
    onNewReaderDisable() {
      const args = {
        title: "Are you sure?",
        message: 'Watch out! Once you disable new reader mode, major Homestuck spoilers will immediately become visible on many pages of the collection. Are you sure you want to go ahead?'
      }
      ipcRenderer.invoke('prompt-okay-cancel', args).then(answer => {
        if (answer === true) {
          this.newReaderPage = this.$mspaOrVizNumber(this.$newReaderCurrent)
          this.$localData.root.NEW_READER_CLEAR()
        }
      })
    },
    onChangeThemeOverride(){
      // Disable override of the "forced" theme is default
      if (this.$localData.settings.themeOverride == "default")
        this.$localData.settings.forceThemeOverride = false
      this.$localData.root.saveLocalStorage()
    },
    toggleDarkMode(){
      if (this.darkModeChecked) {
        // Uncheck "dark mode"
        this.$localData.settings.themeOverride = "default"
      } else {
        // Check "dark mode style"
        this.$localData.settings.themeOverride = "dark"
      }
      this.$localData.root.saveLocalStorage()
    },
    forceThemeOverrideUINewReader(){
      if (this.forceThemeOverrideUINewReaderChecked) {
        // Uncheck "never style"
        this.$localData.settings.themeOverrideUI = "default"
        this.$localData.settings.forceThemeOverrideUI = false
      } else {
        // Check "never style"
        this.$localData.settings.themeOverrideUI = "mspa"
        this.$localData.settings.forceThemeOverrideUI = true
      }
      this.$localData.root.saveLocalStorage()
    },
    toggleAllControversial() {
      if (this.controversialAny) {
        // Normally checking an indeterminate checkbox enables it,
        // but we want to clear it instead.
        
        // eslint-disable-next-line no-return-assign
        this.allControversial.forEach(key => this.$localData.settings[key] = false)
        this.$el.querySelectorAll("input[name=enableControversial]").forEach(i => {i.checked = false})
      } else {
        const args = {
          title: "Are you sure?",
          message: this.enableAllControversialConfirmMsg
        }
        ipcRenderer.invoke('prompt-okay-cancel', args).then(answer => {
          if (answer === true) {
            // eslint-disable-next-line no-return-assign
            this.allControversial.forEach(key => this.$localData.settings[key] = true)
          } else {
            this.$el.querySelectorAll("input[name=enableControversial]").forEach(i => {i.checked = false})
          }
        })
      }
    },
    toggleSetting(setting, parentObject){
      // Call this when a setting changes, so we can update it on the parent object.
      // Doesn't actually toggle settings.
      if (!(setting in this.$localData.settings) || (parentObject in this.$localData.settings && !(setting in this.$localData.settings[parentObject]))) this.$set(this.$localData.settings, setting, true)
      else if (parentObject && setting in this.$localData.settings[parentObject]) this.$localData.settings[parentObject][setting] = !this.$localData.settings[parentObject][setting]
      else this.$localData.settings[setting] = !this.$localData.settings[setting]

      if (setting == 'notifications' && this.$localData.settings[setting]) {
        this.$pushNotif({
          title: 'NOTIFICATIONS ENABLED',
          desc: 'You can click me to visit whatever you just unlocked!',
          url: '/',
          thumb: '/archive/collection/archive_news.png'
        })
      }

      // Unforce if theme just changed to auto
      if (setting == 'themeOverride' && this.$localData.settings.themeOverride == "default")
        this.$localData.settings.forceThemeOverride = false

      // Call this before queueing archive reload
      this.$localData.root.saveLocalStorage()

      if (['unpeachy', 'pxsTavros', 'bolin', 'hqAudio', 'soluslunes'].includes(setting)) {
        this.queueArchiveReload()
      }

      if (setting == 'useSystemWindowDecorations') {
        // this.$localData.root.saveLocalStorage()
        this.$nextTick(() => {ipcRenderer.invoke('restart')})
      }
    },
    locateAssets(){
      ipcRenderer.invoke('locate-assets', {restart: true})
    },
    factoryReset(){      
      const args = {
        title: "FACTORY RESET",
        message: 'Are you absolutely sure? This will reset everything: Your reading progress, tab history, save files, and settings will all be completely gone!',
        okay: "Yes, delete everything"
      }
      ipcRenderer.invoke('prompt-okay-cancel', args).then(answer => {
        if (answer === true) {
          this.$localData.root.clearLocalStorage()
          Mods.store_mods.clear()
          // ipcRenderer.invoke('restart')
        }
      })
    },
    onUpdateSortable: function(event){
      const el_active = event.target

      if (!el_active) {
        this.$logger.error("Got onUpdateSortable with no event target?")
        throw Error("Cannot update sortable with no specified target")
      }

      const setting_key = el_active.attributes['data-setting'].value
      const reordered_item = event.item.attributes['data-value'].value

      // Get lists of values
      const old_list = this.$localData.settings[setting_key]
      const list_active = [...el_active.children].map((child) =>
        child.attributes['data-value'].value
      )
      this.$localData.settings[setting_key] = list_active

      // Calculte needReload
      let diff = [reordered_item]
      diff = diff.concat(list_active.filter(x => !old_list.includes(x)))
      diff = diff.concat(old_list.filter(x => !list_active.includes(x)))

      try {
        if (diff.some(key => this.$root.$modChoices[key].needsHardReload)) {
          this.$logger.info("List change requires hard reload", diff)
          this.needReload = true
        }
        if (diff.some(key => this.$root.$modChoices[key].needsArchiveReload)) {
          this.$logger.info("List change requires archive reload", diff)
          this.queueArchiveReload()
        }
      } catch (e) {
        // Sometimes keys aren't in modChoices yet
        this.$logger.error(e)
        this.needReload = true
        this.queueArchiveReload()
      }
    },
    queueArchiveReload(){
      if (this.debounce) clearTimeout(this.debounce)
      this.debounce = setTimeout(this.archiveReload, 8000)
    },
    archiveReload(){
      this.debounce = false 

      this.$root.app.archiveReload()
    },
    openSubModel: function(mod, info_only) {
      this.$refs.modal.openMod(mod, (info_only || false))
    },
    forceReload: function() {
      this.$localData.VM.saveLocalStorage()
      this.$localData.VM._saveLocalStorage()
      this.$root.loadState = "LOADING"
      ipcRenderer.invoke('reload')
    },
    reloadModList: function() {
      Mods.loadModChoicesAsync().then(_ => {
        this.$root.$asyncComputed.$modChoices.update()
        // this._computedWatchers.modsEnabled.run()
        // this._computedWatchers.modsDisabled.run()
        this.$forceUpdate()
      })
    },
    scrollToSec(sectionClass) {
      this.$el.querySelector(`.settings.${sectionClass}`).scrollIntoView(true)
    },
    trackSettings() {
      // Log settings, for debugging
      this.$logger.info(this.$localData.settings)
    }
  },
  mounted(){
    if (this.routeParams.sec) {
      this.$nextTick(() => this.scrollToSec(this.routeParams.sec))
    }
  },
  destroyed() {
    this.trackSettings()
  },
  watch: {
    'tab.history': function (to, from) {
      if (this.routeParams.sec) {
        this.scrollToSec(this.routeParams.sec)
      }
    },
    '$localData.tabData.activeTabKey'(to, from) {
      if (to == this.tab.key || from == this.tab.key) {
        if (this.needReload) {
          this.forceReload()
          // forceReload includes archiveReload
        } else if (this.debounce) {
          clearTimeout(this.debounce)
          this.debounce = false
          this.archiveReload()
        }
      }
    }
  }
}
</script>

<style scoped lang="scss">
  .pageBody {
    color: var(--font-default);
    
    margin: 0;
    padding: 0;
    display: flex;
    flex-flow: column;
    flex: 1 0 auto;
    align-items: center;

    background: var(--system-background);
    background-color: var(--system-skycolor);
    
    ::v-deep a {
      color: var(--page-links);
    }
  }

  ::v-deep .spoilerbox .settings {
    color: var(--font-log);
  }

  .navBanner {
    margin-bottom: 25px;
  }
  .card {
    position: relative;
    margin-bottom: 50px;
    padding: 0 50px;
    border: solid 5px var(--page-pageBorder, var(--page-pageFrame));
    box-sizing: border-box;
    width: 950px;
    max-width: 100vw;
    background: var(--page-pageContent);

    flex: 0 1 auto;
    display: flex;
    flex-flow: column nowrap;
    align-items: center;
    align-content: center;

    font-family: Verdana,Arial,Helvetica,sans-serif;
    
  }
  .settings {
    width: 100%;
    padding: 25px 0;

    &:not(:last-child) {
      border-bottom: solid 2px var(--page-pageBorder, var(--page-pageFrame));
    }
    h2 { text-align: center; }
    p {
      font-weight: normal;
      margin: 10px 0 5px 10px;
      label {
        font-weight: bolder;
      }
    }
    dt { margin: 20px 0 5px 10px; }
    .settingDesc {
      color: var(--page-nav-meta);
      font-weight: normal;
    }

    div.subOption { margin-left: 40px; }

    > dd.settingDesc {
      // Descriptions of whole sections
      margin-top: 1em;
    }
    
    .system {
      margin-top: 20px;
      text-align: center;
      font-weight: normal;
    }

    .needreload {
      color: red;
      font-weight: bold;
    }

    .newReaderInput {
      margin-top: 20px;
      text-align: center;

      button {
          margin-bottom: 1em;
      }
      input {
        border: 1px solid #777;
        width: 70px;
        font-size: 110%;
        border-radius: 2px;
        padding: 2px 3px;
        margin: 5px;

        &.invalid:not(:disabled):not(.empty) {
          background: pink;
          border-color: rgb(187, 0, 37);
          box-shadow: 0 0 3px 1px red;
        }
        &.changed {
          border-color: #ffaa00;
          box-shadow: 0 0 3px 1px red;
        }
      }
    }

    &.mod button.reload {
      margin: 0.5em;
      padding: 0.5em;
      min-width: 140px;
    }

    button {
      font-size: 110%;
    }
    .hint {
      font-size: 13px;
      color: var(--page-nav-meta);
      button {
        font-size: 1em;
        padding: 0 4px;
      }
    }
    .themeSelector, .fontSelector {
      font-size: 16px;
    }
    .themeSelector + dt {
      display: inline;
    }
    // Little ones
    &.retcons dl {
      column-count: 2;
      dt:first-child {
        margin-top: 0;
      }
    }
    .textOverrideSettings {
      margin-top: 16px;
      text-align: center;
          
      .textOptions label {
        display: block;
      }

      label.fontslider {
        display: block;
        margin-top: 1em;
      }

      .textpreviews {
        border: 6px solid var(--page-pageFrame);
        padding: 6px;
        position: relative;
        left: 0;
      }

      .knobs {
        width: 75%;
        margin: 0 auto 16px;
        text-align: left;
        select {
          margin: 5px 0;
        }
        input[type="range"] {
          width: 100%;
        }
      }
      div.examplePrattle, p.examplePrattle {
        margin-bottom: 16px;
      }
      .examplePrattle {
        margin: 0 auto;

        ::v-deep .text{
          // text-align: center;
        }
        &.bold {
          font-weight: bold;
        }
      }
    }
    .ccPageNos {
      font-weight: normal;
    }

    span.cw {
      padding: 0 7px;
      font-size: 12px;
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI;
      font-weight: 500;
      line-height: 18px;
      border: 1px solid transparent;
      border-radius: 2em;
      margin-left: 1em;
      &.minor {
        background-color: #fbca04;
        color: #000000;
      }
      &.severe{
        background-color: #d93f0b;
        color: #ffffff;
      }
    }
  }
  .sortable {
    font-weight: normal;
    margin: 1em 0;
    
    // Ignore card margins for sortable on tiny screens
    @media (max-width: 650px) {
      margin: 1em -50px;
    }

    ul, ol {  
      text-align: left;        
      border: solid var(--page-pageBorder, var(--page-pageFrame));
      border-width: 5px 5px 0 0;
      padding-bottom: 6em;
      height: 100%;
      max-height: 60vh;
      overflow: auto;
    }

    li {
      // TODO Use a background color here from the theme that isn't log-bg
      color: var(--font-log);
      background-color: var(--page-log-bg);
      // border: 1px solid rgba(0,0,0,.125);
      border: 1px solid var(--page-pageBorder);
      margin-bottom: -1px;
      padding: .2em;
      .summary:before {
        content: ' - '
      }
      &:hover {
        cursor: grab;
      }
      &:active {
        cursor: grabbing;
      }
    }

    ul li {
        list-style: none;
    }

    ol li {
      list-style: decimal;
    }

    .col {  
      width: 100%;
      margin: 0 20px;
    }
    .modButton {
      float: right;
      width: 18px;
      height: 18px;
      background: var(--saves-tab);
      text-align: center;
      &:hover {
        background: var(--saves-tabHover)
      }
    }
  }

  .col {
    display: flex;
    flex-direction: column;
    overflow: auto;
  }

  .row {
    display: flex;
  }

</style>
